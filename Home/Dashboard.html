<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>AppLearn</title>
        <link rel="stylesheet" href="./site.css">
        <script defer src="./site.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-..." crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">
        <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <meta name="google-site-verification" content="google-site-verification=Vg-8DmrfXh_lOY8Ys2n_HG9DijL0fi0xH69efb3Bjf8">

        <style id="freeze-dashboard-anims">
            html * {
              animation: none !important;
              animation-play-state: paused !important;
              transition: none !important;
            }
          
            .scribble, #myPath, #follower {
              display: none !important;
            }
          
            .AI-Background .star,
            .AI-Background .meteor-belt {
              display: none !important;
            }
          
            body {
                background: url("img/Untitled%20design%20(10).png") center/cover fixed no-repeat !important;
            }
            .AI-Background {
              min-height: 40vh; 
              background: transparent !important; 
            }
        </style>          
    </head>
<body style="font-family: Arial, Helvetica, sans-serif;">
    <header class="header" id="navbar">
        <nav class="navbar navbar-expand-sm navbar-toggleable-sm navbar-light border-bottom box-shadow mb-3">
            <div class="container-fluid">
                <!-- Toggler Button for Mobile View -->
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target=".navbar-collapse" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Company/App Logo or Name -->
                <a class="navbar-brand" asp-area="" asp-controller="Home" asp-action="Index">
                    <img src="./img/App-Learn%20Wordmark%20V1.png" alt="Company Logo" style="height: 80px; width: 250px;">
                </a>

                <!-- Navigation Links (Centered) -->
                <div class="navbar-collapse collapse d-sm-flex justify-content-center">
                    <div class="nav-fonts">
                        <ul class="navbar-nav">
                            <li class="nav-item">
                                <a class="nav-link" asp-area="" asp-controller="Home" asp-action="Index" style="color: white;" href="Home.html">Home</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" asp-area="" asp-controller="Games" asp-action="Index" style="color: white;" href="Explore.html">Explore</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" asp-area="" asp-controller="About" asp-action="Index" style="color: white;" href="AboutUs.html">About Us</a>
                            </li>
                            <!--
                            <li class="nav-item">
                                <a class="nav-link" asp-area="" asp-controller="Plans" asp-action="Index" style="color: white;">Plans</a>
                            </li>
                            -->
                            <li class="nav-item">
                                <a class="nav-link" asp-area="" asp-controller="Dashboard" asp-action="Index" style="color: white;" href="Dashboardchoice.html">Dashboard</a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="button-container">
                    <a id="loginNavBtn" class="btn btn-dark btn-lg" href="sign_in.html">Login</a>
                    <a id="signupNavBtn" class="btn btn-dark btn-lg" href="StudentorTeacher.html">Sign-Up</a>
                    <button id="logoutNavBtn" class="btn btn-dark btn-lg" style="display:none;">Logout</button>
                  </div>
                  
                  
            </div>
        </nav>
    </header>
    <svg preserveaspectratio="xMidYMax meet" fill="none" class="scribble">
            <path id="myPath" style="opacity: 0.75;" d="M1 4C191.518 9.2973 552.715 38.3946 473.359 112.406C447.379 131.514 368.967 175.86 263.159 200.379C198.603 211.73 86.4969 214.114 154.517 132.838C210.412 74.5677 375.816 10.5838 590.267 220.811C804.718 431.038 1121.93 539.566 1235.73 508.702C1349.1 497.351 1463.09 283.289 1294.93 192.932C1126.77 102.575 911.112 213.629 840.203 273.599C752.217 348.011 737.479 433.996 739.368 500.742C741.258 567.488 810.278 704.533 864.923 750.704C928.438 804.37 1076.56 911.769 1288.18 876.353C1499.79 840.936 1415.28 655.177 1251.35 670.037C1127.09 670.037 990.478 820.758 1274.12 897.18C1285.39 901.071 1345.16 911.084 1494 920" stroke="#1F959C" stroke-width="8"></path>
            <circle id="follower" r="5" fill="#9b1f17"></circle>
    </svg>   
    <section class="AI-Background">
        <div>
            <span class="star"></span>
            <span class="star"></span>
            <span class="star"></span>
            <span class="star"></span>
            <span class="star"></span>
            <span class="star"></span>
            <span class="star"></span>
            <span class="star"></span>
            <span class="star"></span>
            <span class="star"></span>
        </div>
        <div>
            <div class="meteor-belt">
                <div class="meteor" id="meteor1"></div>
                <div class="meteor" id="meteor2"></div>
                <div class="meteor" id="meteor3"></div>
                <div class="meteor" id="meteor4"></div>
                <div class="meteor" id="meteor5"></div>
                <div class="meteor" id="meteor6"></div>
                <div class="meteor" id="meteor7"></div>
                <div class="meteor" id="meteor8"></div>
                <div class="meteor" id="meteor9"></div>
                <div class="meteor" id="meteor10"></div>
            </div>
        </div>
    </section>  
    <div class="divideLine"></div>
    <h1 style=" padding-top:160px; padding-bottom:5vh; color:white; text-align: center;font-size:50px;">ALGEBRA</h1> 
    <div class="summary-header" style="display: flex;align-items: center;justify-content: center;gap:50px;">
        <div style="flex-grow: 1;height: 2px;background-color: #9b1f17;"></div>
        <div style="white-space: nowrap; color:#1ebcc8; font-size:30px; font-weight:bold;">CLASS SUMMARY</div>
        <div style="flex-grow: 1;height: 2px;background-color: #9b1f17;"></div>
    </div>
    <div style="display: flex;justify-content: center;align-items: center; flex-wrap: wrap;">
        <div class="class-summary" style="flex:1; margin:50px; align-items: center; flex-grow:1">
            <div class="stat-panel">
                <div class="stat-row" style="justify-content: center; text-align: center;">
                  <img src="img/eye.png" class="stat-icon" alt="Views">
                  <div class="stat-label" style="text-align: center;">Views</div>
                  <div class="stat-bar"></div>
                </div>
                <div class="stat-row" style="justify-content: center; text-align: center;">
                  <img src="img/target.png" class="stat-icon" alt="Attempts">
                  <div class="stat-label" style="text-align: center;">Attempts</div>
                  <div class="stat-bar"></div>
                </div>
                <div class="stat-row" style="justify-content: center; text-align: center;">
                  <img src="img/checkmark.png" class="stat-icon" alt="Completions">
                  <div class="stat-label" style="text-align: center;">Completions</div>
                  <div class="stat-bar"></div>
                </div>
              </div>
        </div>
        <div class="class-summary" style="flex:1; margin:50px;">
            <div class="stat-panel">
                <div class="stat-row" style="justify-content: center; text-align: center;">
                  <img src="img/likes.png" class="stat-icon" alt="Views">
                  <div class="stat-label" style="text-align: center;">Likes</div>
                  <div class="stat-bar"></div>
                </div>
                <div class="stat-row" style="justify-content: center; text-align: center;">
                  <img src="img/percent.png" class="stat-icon" alt="Attempts">
                  <div class="stat-label" style="text-align: center;">Success Rate</div>
                  <div class="stat-bar"></div>
                </div>
                <div class="stat-row" style="justify-content: center; text-align: center;">
                  <img src="img/meter.png" class="stat-icon" alt="Completions">
                  <div class="stat-label" style="text-align: center;">Learning Pace Metric</div>
                  <div class="stat-bar"></div>
                </div>
              </div>
        </div>
        <div class="class-summary" style="flex:2; margin:50px; flex-grow:1">
            <div class="stat-panel">
                <div class="stat-row" style="margin:auto; justify-content: center; text-align: center;">
                    <figure>
                        <img src="img/sisyphus.png" class="stat-icon" alt="Views">
                        <figcaption><div class="stat-label" style="width:120px;; text-align: center;">Concepts<br> Most Struggled</div></figcaption>
                    </figure>
                    <div class="stat-bar" style="width:500px; height:60px;"></div>
                </div>
                <div class="stat-row" style="margin:auto; justify-content: center; text-align: center;">
                    <figure>
                        <img src="img/lightbulb.png" class="stat-icon" alt="Attempts">
                        <figcaption><div class="stat-label" style="width:120px;; text-align: center;">Class Insights</div></figcaption>
                    </figure>
                <div class="stat-bar" style="width:500px;height:60px"></div>
                </div>
            </div>
          </div>
    </div>
    
    <div class="topics-header" style="display: flex;align-items: center;justify-content: center;gap:50px;">
        <div style="flex-grow: 1;height: 2px;background-color: #9b1f17;"></div>
        <div style="white-space: nowrap; color:#1ebcc8; font-size:30px; font-weight:bold;">TOPICS &amp; SCENARIOS</div>
        <div style="flex-grow: 1;height: 2px;background-color: #9b1f17;"></div>
    </div>
    <div class="topics-wrapper" style="display: flex;flex-wrap:wrap; flex-grow:grow; justify-content: center; margin-bottom:50px;">
        <div class="topicdiv">
            <h4 class="topictitle">Linear Equations</h4>
            <div class="topicparent">
            <div class="topiccontainer">
                <div></div>
                <div class="icon"><img class="smallicon" src="img/eye.png" alt=""></div>
                <div class="icon"><img class="smallicon" src="img/target.png" alt=""></div>
                <div class="icon"><img class="smallicon" src="img/checkmark.png" alt=""></div>
                <div class="icon"><img class="smallicon" src="img/likes.png" alt=""></div>
                <div class="icon"><img class="smallicon" src="img/percent.png" alt=""></div>
            
                <div class="row-label" data-video-id="linear-artist" style="font-size:0.9rem;">Artist Scenario</div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
            
                <div class="row-label" data-video-id="linear-youtuber" data-game-id="linear-youtuber-game" data-has-game="true" style="font-size:0.9rem;">YouTuber Scenario</div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
            
                <div class="row-label" data-video-id="linear-athlete" style="font-size:0.9rem;">Athlete Scenario</div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
            
                <div class="row-label" data-video-id="linear-nurse" style="font-size:0.9rem;">Nurse Scenario</div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
            
                <div class="row-label">Aggregate</div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
              </div>            
        </div>
        </div>
        <div class="topicdiv">
            <h4 class="topictitle">Quadratic Equations</h4>
            <div class="topicparent">
            <div class="topiccontainer">
                <div></div>
                <div class="icon"><img class="smallicon" src="img/eye.png" alt=""></div>
                <div class="icon"><img class="smallicon" src="img/target.png" alt=""></div>
                <div class="icon"><img class="smallicon" src="img/checkmark.png" alt=""></div>
                <div class="icon"><img class="smallicon" src="img/likes.png" alt=""></div>
                <div class="icon"><img class="smallicon" src="img/percent.png" alt=""></div>
            
                <div class="row-label" data-video-id="quadratic-youtuber" style="font-size:0.9rem;">YouTuber Scenario</div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
            
                <div class="row-label" data-video-id="quadratic-gamer" style="font-size:0.9rem;">Gamer Scenario</div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
            
                <div class="row-label" data-video-id="quadratic-musician" style="font-size:0.9rem;">Musician Scenario</div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
            
                <div class="row-label">Aggregate</div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
                <div class="square"></div>
              </div>  
              </div>          
        </div>
        <div class="topicdiv">
            <h4 class="topictitle">System of Linear Equations</h4>
            <div class="topicparent">
                <div class="topiccontainer">
                    <div></div>
                    <div class="icon"><img class="smallicon" src="img/eye.png" alt=""></div>
                    <div class="icon"><img class="smallicon" src="img/target.png" alt=""></div>
                    <div class="icon"><img class="smallicon" src="img/checkmark.png" alt=""></div>
                    <div class="icon"><img class="smallicon" src="img/likes.png" alt=""></div>
                    <div class="icon"><img class="smallicon" src="img/percent.png" alt=""></div>
                
                    <div class="row-label">Scenario-1</div>
                    <div class="square"></div>
                    <div class="square"></div>
                    <div class="square"></div>
                    <div class="square"></div>
                    <div class="square"></div>
                
                    <div class="row-label">Scenario-2</div>
                    <div class="square"></div>
                    <div class="square"></div>
                    <div class="square"></div>
                    <div class="square"></div>
                    <div class="square"></div>
                
                    <div class="row-label">Scenario-3</div>
                    <div class="square"></div>
                    <div class="square"></div>
                    <div class="square"></div>
                    <div class="square"></div>
                    <div class="square"></div>
                
                    <div class="row-label">Aggregate</div>
                    <div class="square"></div>
                    <div class="square"></div>
                    <div class="square"></div>
                    <div class="square"></div>
                    <div class="square"></div>
                </div>            
            </div>
        </div>
    </div>
    <div class="student-list-header" style="display: flex;align-items: center;justify-content: center;gap:50px;; text-align: center; justify-content: center;">
        <div style="flex-grow: 1;height: 2px;background-color: #9b1f17;"></div>
        <div style="white-space: nowrap; color:#1ebcc8; font-size:30px; font-weight:bold;">Student List</div>
        <div style="flex-grow: 1;height: 2px;background-color: #9b1f17;"></div>
    </div>
    
    <table>
        <!-- This ensures fixed column widths for proper alignment -->
        <colgroup>
          <col>
          <col>
          <col>
          <col>
          <col>
          <col>
          <col>
          <col>
          <col>
        </colgroup>
    
        <thead>
          <tr style="text-align: center;">
            <th></th>
            <th class="stdlist-icon-header"></th>
            <th class="stdlist-icon-header"><img class="smallicon" src="img/eye.png" alt=""></th>
            <th class="stdlist-icon-header"><img class="smallicon" src="img/target.png" alt=""></th>
            <th class="stdlist-icon-header"><img class="smallicon" src="img/checkmark.png" alt=""></th>
            <th class="stdlist-icon-header"><img class="smallicon" src="img/likes.png" alt=""></th>
            <th class="stdlist-icon-header"><img class="smallicon" src="img/percent.png" alt=""></th>
            <th class="stdlist-icon-header"><img class="smallicon" src="img/meter.png" alt=""></th>
            <th class="stdlist-icon-header"><img class="smallicon" src="img/sisyphus.png" alt=""></th>
          </tr>
        </thead>
        <tbody>
          <tr class="stdrow" style="text-align: center;">
            <td class="stdlist-checkbox" style="text-align: center;"><label class="custom-checkbox"><input type="checkbox" name="" id=""></label></td>
            <td style="text-align: center;">Student-1</td>
            <td style="text-align: center;"><div class="stdlist-red-box"></div></td>
            <td style="text-align: center;"><div class="stdlist-red-box"></div></td>
            <td style="text-align: center;"><div class="stdlist-red-box"></div></td>
            <td style="text-align: center;"><div class="stdlist-red-box"></div></td>
            <td style="text-align: center;"><div class="stdlist-red-box"></div></td>
            <td style="text-align: center;"><div class="stdlist-red-box"></div></td>
            <td style="text-align: center;"><input type="text" class="stdlist-text-box" placeholder="Add a note..."></td>
          </tr>
          <tr class="stdrow" style="text-align: center;">
            <td class="stdlist-checkbox" style="text-align: center;"><label class="custom-checkbox"><input type="checkbox" name="" id=""></label></td>
            <td style="text-align: center;">Student-2</td>
            <td style="text-align: center;"><div class="stdlist-red-box"></div></td>
            <td style="text-align: center;"><div class="stdlist-red-box"></div></td>
            <td style="text-align: center;"><div class="stdlist-red-box"></div></td>
            <td style="text-align: center;"><div class="stdlist-red-box"></div></td>
            <td style="text-align: center;"><div class="stdlist-red-box"></div></td>
            <td style="text-align: center;"><div class="stdlist-red-box"></div></td>
            <td style="text-align: center;"><input type="text" class="stdlist-text-box" placeholder="Add a note..."></td>
          </tr>
          <tr class="stdrow" style="text-align: center;">
            <td class="stdlist-checkbox" style="text-align: center;"><label class="custom-checkbox"><input type="checkbox" name="" id=""></label></td>
            <td style="text-align: center;">Student-3</td>
            <td style="text-align: center;"><div class="stdlist-red-box"></div></td>
            <td style="text-align: center;"><div class="stdlist-red-box"></div></td>
            <td style="text-align: center;"><div class="stdlist-red-box"></div></td>
            <td style="text-align: center;"><div class="stdlist-red-box"></div></td>
            <td style="text-align: center;"><div class="stdlist-red-box"></div></td>
            <td style="text-align: center;"><div class="stdlist-red-box"></div></td>
            <td style="text-align: center;"><input type="text" class="stdlist-text-box" placeholder="Add a note..."></td>
          </tr>
          <tr class="stdrow" style="text-align: center;">
            <td class="stdlist-checkbox" style="text-align: center;"><label class="custom-checkbox"><input type="checkbox" name="" id=""></label></td>
            <td style="text-align: center;">Student-4</td>
            <td style="text-align: center;"><div class="stdlist-red-box"></div></td>
            <td style="text-align: center;"><div class="stdlist-red-box"></div></td>
            <td style="text-align: center;"><div class="stdlist-red-box"></div></td>
            <td style="text-align: center;"><div class="stdlist-red-box"></div></td>
            <td style="text-align: center;"><div class="stdlist-red-box"></div></td>
            <td style="text-align: center;"><div class="stdlist-red-box"></div></td>
            <td style="text-align: center;"><input type="text" class="stdlist-text-box" placeholder="Add a note..."></td>
          </tr>
      <tr class="stdrow" style="text-align: center;">
        <td class="stdlist-checkbox" style="text-align: center;"><label class="custom-checkbox"><input type="checkbox" name="" id=""></label></td>
        <td style="text-align: center;">Student-5</td>
        <td style="text-align: center;"><div class="stdlist-red-box"></div></td>
        <td style="text-align: center;"><div class="stdlist-red-box"></div></td>
        <td style="text-align: center;"><div class="stdlist-red-box"></div></td>
        <td style="text-align: center;"><div class="stdlist-red-box"></div></td>
        <td style="text-align: center;"><div class="stdlist-red-box"></div></td>
        <td style="text-align: center;"><div class="stdlist-red-box"></div></td>
        <td style="text-align: center;"><input type="text" class="stdlist-text-box" placeholder="Add a note..."></td>
      </tr>
    </tbody>
  </table>
  <script>
  (async function () {
    const currentUser = await fetchCurrentUser();
    if (!currentUser) return;
    const role = (currentUser.role || '').toLowerCase();

    if (role === 'student') {
      await setupStudentDashboard();
    } else if (role === 'teacher') {
      await setupTeacherDashboard();
    }
  })();

  async function fetchCurrentUser() {
    try {
      const res = await fetch('/api/me', { credentials: 'include' });
      if (!res.ok) return null;
      const data = await res.json();
      return (data && data.authenticated) ? data : null;
    } catch (_) {
      return null;
    }
  }

  function getSquares(label) {
    if (!label) return [];
    const squares = [];
    let el = label.nextSibling;
    while (el && el.nodeType !== 1) {
      el = el.nextSibling;
    }
    while (el && el.classList && el.classList.contains('square')) {
      squares.push(el);
      el = el.nextSibling;
      while (el && el.nodeType !== 1) {
        el = el.nextSibling;
      }
    }
    return squares;
  }

  function clearSquare(label, index) {
    const squares = getSquares(label);
    if (!squares[index]) return;
    const square = squares[index];
    square.textContent = '';
    square.classList.remove('square-has-data');
    square.removeAttribute('title');
  }

  function setSquareValue(label, index, value, title, blankWhenZero = false) {
    const squares = getSquares(label);
    if (!squares[index]) return;
    const square = squares[index];
    const numeric = Number(value) || 0;
    if (blankWhenZero && numeric <= 0) {
      clearSquare(label, index);
      return;
    }
    square.textContent = String(numeric);
    if (numeric > 0) {
      square.classList.add('square-has-data');
    } else {
      square.classList.remove('square-has-data');
    }
    if (title) {
      square.setAttribute('title', `${title}: ${numeric}`);
    } else {
      square.removeAttribute('title');
    }
  }

  async function updateViews(labels) {
    const idSet = new Set();
    labels.forEach(label => {
      if (label.dataset.videoId) idSet.add(label.dataset.videoId);
      if (label.dataset.gameId) idSet.add(label.dataset.gameId);
    });
    const ids = Array.from(idSet);
    if (!ids.length) return;
    try {
      const response = await fetch(`/api/video/progress?ids=${encodeURIComponent(ids.join(','))}`, {
        credentials: 'include'
      });
      if (!response.ok) return;
      const payload = await response.json();
      if (!payload || !payload.ok || !payload.views) return;
      labels.forEach(label => {
        const viewId = label.dataset.videoId;
        const gameId = label.dataset.gameId;
        const hasGame = label.dataset.hasGame === 'true' && !!gameId;

        const view = viewId ? payload.views[viewId] : null;
        if (!view) {
          clearSquare(label, 0);
        } else {
          const rawViews = Number(view.view_count || 0);
          const progress = Number(view.progress || 0);
          const completed = Boolean(view.completed) || progress >= 0.9;
          const secondsWatched = Number(view.seconds_watched || 0);
          const duration = Number(view.duration || 0);

          let inferredViews = 0;
          if (duration > 0) {
            const ratio = secondsWatched / duration;
            if (ratio >= 0.9) inferredViews = 1;
          }

          const totalViews = rawViews > 0 ? rawViews : (completed ? Math.max(1, inferredViews) : inferredViews);
          if (totalViews > 0) {
            setSquareValue(label, 0, totalViews, 'Views', true);
          } else {
            clearSquare(label, 0);
          }
        }

        if (hasGame) {
          const gameView = payload.views[gameId];
          const attempts = gameView ? Number(gameView.attempt_count || 0) : 0;
          const completions = gameView ? Number(gameView.view_count || 0) : 0;

          if (attempts > 0) {
            setSquareValue(label, 1, attempts, 'Game attempts', true);
          } else {
            clearSquare(label, 1);
          }

          if (completions > 0) {
            setSquareValue(label, 2, completions, 'Game completions', true);
          } else {
            clearSquare(label, 2);
          }
        } else {
          clearSquare(label, 1);
          clearSquare(label, 2);
        }
      });
    } catch (err) {
      console.warn('Failed to fetch video progress', err);
    }
  }

  function updateAggregates() {
    document.querySelectorAll('.topiccontainer').forEach(container => {
      const labels = Array.from(container.querySelectorAll('.row-label')); 
      const columnTotals = [];
      let aggregateLabel = null;

      labels.forEach(label => {
        const squares = getSquares(label);
        if (!squares.length) return;
        if (label.dataset && label.dataset.videoId) {
          squares.forEach((square, idx) => {
            const val = Number(square.textContent) || 0;
            columnTotals[idx] = (columnTotals[idx] || 0) + val;
          });
        } else {
          aggregateLabel = label;
        }
      });

      if (!aggregateLabel) return;
      const squares = getSquares(aggregateLabel);
      squares.forEach((_, idx) => {
        const total = columnTotals[idx] || 0;
        if (idx === 0) {
          setSquareValue(aggregateLabel, idx, total, 'Total views', true);
        } else if (idx === 1) {
          setSquareValue(aggregateLabel, idx, total, 'Total game attempts', true);
        } else if (idx === 2) {
          setSquareValue(aggregateLabel, idx, total, 'Total game completions', true);
        } else {
          clearSquare(aggregateLabel, idx);
        }
      });
    });
  }

  async function setupStudentDashboard() {
    document.querySelectorAll('.class-summary').forEach(el => { el.style.display = 'none'; });
    const summaryHeader = document.querySelector('.summary-header');
    if (summaryHeader) summaryHeader.style.display = 'none';
    const studentHeader = document.querySelector('.student-list-header');
    if (studentHeader) studentHeader.style.display = 'none';
    const studentTable = document.querySelector('table');
    if (studentTable) studentTable.style.display = 'none';

    const labelNodes = Array.from(document.querySelectorAll('.row-label[data-video-id]'));

    labelNodes.forEach(label => {
      const squares = getSquares(label);
      squares.forEach((_, idx) => {
        clearSquare(label, idx);
      });
    });

    await updateViews(labelNodes);
    updateAggregates();
  }

  function hideTopicsSection() {
    document.querySelectorAll('.topics-header, .topics-wrapper').forEach(el => {
      el.style.display = 'none';
    });
  }

  function updateClassSummary(summary) {
    const studentCount = summary.student_count || 0;
    const totalViews = summary.total_views || 0;
    const totalAttempts = summary.total_attempts || 0;
    const avgViews = studentCount ? Math.round(totalViews / studentCount) : 0;
    const avgAttempts = studentCount ? Math.round(totalAttempts / studentCount) : 0;

    const values = [
      totalViews,
      totalAttempts,
      studentCount,
      avgViews,
      avgAttempts
    ];

    const labels = [
      'Total Views',
      'Total Attempts',
      'Students',
      'Avg Views / Student',
      'Avg Attempts / Student'
    ];

    const rows = document.querySelectorAll('.stat-panel .stat-row');
    rows.forEach((row, idx) => {
      const labelEl = row.querySelector('.stat-label');
      const bar = row.querySelector('.stat-bar');
      if (!bar) return;
      if (labelEl && labels[idx]) {
        labelEl.textContent = labels[idx];
      }
      const value = values[idx];
      bar.style.display = 'flex';
      bar.style.alignItems = 'center';
      bar.style.justifyContent = 'center';
      bar.style.width = '150px';
      bar.style.height = '40px';
      bar.style.backgroundColor = '#8b2c20';
      bar.style.color = '#ffffff';
      bar.style.fontWeight = '600';
      bar.style.fontSize = '0.95rem';
      bar.textContent = typeof value === 'number' ? value.toLocaleString() : '';
    });
  }

  function createMetricCell(value) {
    const td = document.createElement('td');
    const div = document.createElement('div');
    div.className = 'stdlist-red-box';
    if (value !== null && value !== undefined && value !== '') {
      div.textContent = typeof value === 'number' ? value.toLocaleString() : value;
    }
    td.appendChild(div);
    return td;
  }

  function buildStudentTable(students) {
    const tbody = document.querySelector('table tbody');
    if (!tbody) return;
    tbody.innerHTML = '';

    if (!students.length) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 9;
      td.textContent = 'No students yet.';
      td.style.color = '#ffffff';
      td.style.textAlign = 'center';
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    students.forEach(student => {
      const tr = document.createElement('tr');
      tr.className = 'stdrow';

      const checkboxTd = document.createElement('td');
      checkboxTd.className = 'stdlist-checkbox';
      const label = document.createElement('label');
      label.className = 'custom-checkbox';
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      label.appendChild(checkbox);
      checkboxTd.appendChild(label);
      tr.appendChild(checkboxTd);

      const nameTd = document.createElement('td');
      nameTd.textContent = student.full_name || `${student.first_name || ''} ${student.last_name || ''}`.trim();
      tr.appendChild(nameTd);

      tr.appendChild(createMetricCell(student.total_views || 0));
      tr.appendChild(createMetricCell(student.total_attempts || 0));
      tr.appendChild(createMetricCell(''));
      tr.appendChild(createMetricCell(''));
      tr.appendChild(createMetricCell(''));
      tr.appendChild(createMetricCell(''));

      const noteTd = document.createElement('td');
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'stdlist-text-box';
      input.placeholder = 'Add a note...';
      noteTd.appendChild(input);
      tr.appendChild(noteTd);

      tbody.appendChild(tr);
    });
  }

  async function setupTeacherDashboard() {
    hideTopicsSection();
    const summaryHeader = document.querySelector('.summary-header');
    if (summaryHeader) summaryHeader.style.display = '';
    document.querySelectorAll('.class-summary').forEach(el => { el.style.display = ''; });
    const studentHeader = document.querySelector('.student-list-header');
    if (studentHeader) studentHeader.style.display = '';
    const studentTable = document.querySelector('table');
    if (studentTable) studentTable.style.display = '';

    try {
      const res = await fetch('/api/teacher/stats', { credentials: 'include' });
      if (!res.ok) return;
      const payload = await res.json();
      if (!payload || !payload.ok) return;
      updateClassSummary(payload.summary || {});
      buildStudentTable(payload.students || []);
    } catch (err) {
      console.warn('Failed to fetch teacher stats', err);
    }
  }
</script>
<footer class="footer-distributed border-top " style="background-color: #9b1f17;">
    <div class="footer-left">
        <h3><img src="./img/App-Learn%20Wordmark%20V1.png" alt="Company Logo" style="height: 90px; width: 300px;"></h3>
        <p class="footer-links">
            <a href="#" class="link-1" id="footer-hover-links">HOME</a>
            <a>|</a>
            <a href="#" id="footer-hover-links">BLOG</a>
            <a>|</a>
            <a href="#" id="footer-hover-links">PRICING</a>
            <a>|</a>
            <a href="#" id="footer-hover-links">ABOUT</a>
            <a>|</a>
            <a href="#" id="footer-hover-links">FAQ</a>
            <a>|</a>
            <a href="#" id="footer-hover-links">CONTACT</a>
        </p>
        <p class="footer-company-name">AppLearn Â© 2023</p>
    </div>
    <div class="footer-center">
        <div>
            <i class="fa fa-map-marker"></i>
            <p><span>1234 E West Street</span> Evansville, Indiana</p>
        </div>
        <div>
            <i class="fa fa-phone"></i>
            <p>+1.123.456.7890</p>
        </div>
        <div>
            <i class="fa fa-envelope"></i>
            <p><a href="mailto:support@company.com">support@AppLearn.com</a></p>
        </div>
    </div>
    <div class="footer-right">
        <p class="footer-company-about">
            <span>About AppLearn</span>
            Lorem ipsum dolor sit amet, consectateur adispicing elit. Fusce euismod convallis velit, eu auctor lacus vehicula sit amet.
        </p>
        <div class="footer-icons">
            <a href="#"><i class="fab fa-facebook"></i></a>
            <a href="#"><i class="fab fa-twitter"></i></a>
            <a href="#"><i class="fab fa-linkedin"></i></a>
            <a href="#"><i class="fab fa-instagram"></i></a>
        </div>
    </div>
</footer>
</body>
</html>
