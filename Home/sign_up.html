<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AppLearn â€“ Sign Up</title>
  <link rel="stylesheet" href="sign_in.css" />
  <script defer src="./site.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<header class="header" id="navbar">
  <nav class="navbar navbar-expand-sm navbar-light border-bottom box-shadow mb-3">
    <div class="container-fluid">
      <a class="navbar-brand" href="Home.html">
        <img src="./img/App-Learn Wordmark V1.png" alt="AppLearn" style="height:80px;width:250px;">
      </a>
      <div class="navbar-collapse collapse d-sm-flex justify-content-center">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link" style="color:white;" href="Home.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" style="color:white;" href="Explore.html">Explore</a></li>
          <li class="nav-item"><a class="nav-link" style="color:white;" href="AboutUs.html">About Us</a></li>
          <li class="nav-item"><a class="nav-link" style="color:white;" href="Dashboardchoice.html">Dashboard</a></li>
        </ul>
      </div>
      <div class="button-container">
        <a id="loginNavBtn" class="btn btn-dark btn-lg" href="sign_in.html">Login</a>
        <a id="signupNavBtn" class="btn btn-dark btn-lg" href="StudentorTeacher.html">Sign-Up</a>
        
      </div>
    </div>
  </nav>
</header>

<main class="container" style="max-width:560px; padding-top:120px; padding-bottom:60px;">
  <h1 class="mb-4 text-center">Create your account</h1>
  <div id="signupAlert" class="alert alert-danger d-none"></div>

  <form id="signupForm" class="card p-4 shadow-sm">
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">First name</label>
        <input id="first_name" class="form-control" required>
      </div>
      <div class="col-md-6">
        <label class="form-label">Last name</label>
        <input id="last_name" class="form-control" required>
      </div>
      <div class="col-12">
        <label class="form-label">Email</label>
        <input id="email" type="email" class="form-control" required>
      </div>
      <div class="col-12">
        <label class="form-label d-block">I am signing up as</label>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="role" id="role_student" value="student" required>
          <label class="form-check-label" for="role_student">Student</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="role" id="role_teacher" value="teacher" required>
          <label class="form-check-label" for="role_teacher">Teacher</label>
        </div>
      </div>
      <div class="col-12">
        <label class="form-label" for="school">School</label>
        <select id="school" class="form-select" required>
          <option value="" disabled selected>Select your school</option>
          <option value="School A">School A</option>
          <option value="School B">School B</option>
          <option value="School C">School C</option>
        </select>
      </div>
      <div class="col-12">
        <label class="form-label">Password</label>
        <input id="password" type="password" class="form-control" minlength="6" required>
      </div>
      <div class="col-12">
        <label class="form-label">Confirm password</label>
        <input id="confirm" type="password" class="form-control" minlength="6" required>
      </div>
    </div>
    <button class="btn btn-dark btn-lg w-100 mt-4" type="submit">Sign Up</button>
    <p class="mt-3 mb-0 text-center">Already have an account? <a href="sign_in.html">Log in</a></p>
  </form>
</main>

<script>
  async function parseResponse(res) {
    const text = await res.text();                       // read once
    try { return { data: JSON.parse(text), raw: text }; }
    catch { return { data: null, raw: text }; }
  }
  
  const params = new URLSearchParams(window.location.search);
  const defaultRole = (params.get('role') || '').toLowerCase();
  if (defaultRole === 'student' || defaultRole === 'teacher') {
    const input = document.querySelector(`input[name="role"][value="${defaultRole}"]`);
    if (input) input.checked = true;
  } else {
    const studentRadio = document.getElementById('role_student');
    if (studentRadio) studentRadio.checked = true;
  }
  
  document.getElementById('signupForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const first_name = document.getElementById('first_name').value.trim();
    const last_name  = document.getElementById('last_name').value.trim();
    const email      = document.getElementById('email').value.trim();
    const roleInput  = document.querySelector('input[name="role"]:checked');
    const school     = document.getElementById('school').value;
    const password   = document.getElementById('password').value;
    const confirm    = document.getElementById('confirm').value;
  
    const alertBox = document.getElementById('signupAlert');
    const showErr = (msg) => { alertBox.textContent = msg; alertBox.classList.remove('d-none'); };
    alertBox.classList.add('d-none');
  
    if (!roleInput) return showErr("Please choose student or teacher.");
    if (password !== confirm) return showErr("Passwords do not match.");
  
    const role = roleInput.value;
  
    try {
      const res = await fetch('/api/signup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ first_name, last_name, email, password, school, role })
      });
  
      const { data, raw } = await parseResponse(res);
  
      // Prefer JSON error if provided; otherwise show raw text
      if (!res.ok || !data || !data.ok) {
        const msg = (data && (data.error || data.message)) || raw || 'Sign up failed';
        throw new Error(msg);
      }
  
      // Success
      window.location.href = 'email_verify.html';
    } catch (err) {
      showErr(err.message);
    }
  });
  </script>
  
</body>
</html>
